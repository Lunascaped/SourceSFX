const GAMES={hl1:{name:"Half-Life",repo:"sourcesounds/hl1",host:"github"},bshift:{name:"Half-Life: Blue Shift",repo:"sourcesounds/bshift",host:"github"},hl2:{name:"Half-Life 2",repo:"sourcesounds/hl2",host:"github"},episodic:{name:"Half-Life 2: Episode One",repo:"sourcesounds/episodic",host:"github"},ep2:{name:"Half-Life 2: Episode Two",repo:"sourcesounds/ep2",host:"github"},hl2dm:{name:"Half-Life 2: Deathmatch",repo:"sourcesounds/hl2dm",host:"github"},lostcoast:{name:"Half-Life 2: Lost Coast",repo:"sourcesounds/lostcoast",host:"github"},tf2:{name:"Team Fortress 2",repo:"sourcesounds/tf2",host:"github"},tfc:{name:"Team Fortress Classic",repo:"sourcesounds/tfc",host:"github"},cstrike:{name:"Counter-Strike: Source",repo:"sourcesounds/cstrike",host:"github"},csgo:{name:"Counter-Strike: Global Offensive",repo:"sourcesounds/csgo",host:"github"},czero:{name:"Counter-Strike: Condition Zero",repo:"sourcesounds/czero",host:"github"},portal:{name:"Portal",repo:"sourcesounds/portal",host:"github"},portal2:{name:"Portal 2",repo:"sourcesounds/portal2",host:"github"},left4dead:{name:"Left 4 Dead",repo:"sourcesounds/left4dead",host:"github"},left4dead2:{name:"Left 4 Dead 2",repo:"sourcesounds/left4dead2",host:"github"},dod:{name:"Day of Defeat",repo:"sourcesounds/dod",host:"github"},dods:{name:"Day of Defeat: Source",repo:"sourcesounds/dods",host:"github"},garrysmod:{name:"Garry's Mod",repo:"sourcesounds/garrysmod",host:"github"},zps:{name:"Zombie Panic! Source",repo:"sourcesounds/zps",host:"github"},ricochet:{name:"Ricochet",repo:"",host:"cdn"},treason:{name:"Klaus Veen's Treason",repo:"",host:"cdn"}};let currentGame="hl1",allSounds=[],filteredSounds=[],displayedSounds=[],currentAudioUrl=null,currentAudioBlob=null,currentAudioFileName=null,isSeeking=!1,fuse=null,rafId=null,lastTimeDisplayUpdate=0,currentPage=0;const ITEMS_PER_PAGE=50;let isLoadingMore=!1,hasMoreToLoad=!0,isSearching=!1,currentMidiUrl=null,currentMidiBlob=null,currentMidiFileName=null,midiPlayer=null,midiVisualizer=null;const gameSelect=document.getElementById("gameSelect"),searchInput=document.getElementById("searchInput"),categoryFilter=document.getElementById("categoryFilter"),characterFilter=document.getElementById("characterFilter"),soundList=document.getElementById("soundList"),soundCount=document.getElementById("soundCount"),loadingMessage=document.getElementById("loadingMessage"),loadingMoreIndicator=document.getElementById("loadingMoreIndicator"),errorMessage=document.getElementById("errorMessage"),audioPlayer=document.getElementById("audioPlayer"),audioPlayerContainer=document.getElementById("audioPlayerContainer"),nowPlaying=document.getElementById("nowPlaying"),downloadBtn=document.getElementById("downloadBtn"),closePlayer=document.getElementById("closePlayer"),formatMenu=document.getElementById("formatMenu"),enableConversionToggle=document.getElementById("enableConversionToggle"),playPauseBtn=document.getElementById("playPauseBtn"),playIcon=document.getElementById("playIcon"),pauseIcon=document.getElementById("pauseIcon"),progressBar=document.getElementById("progressBar"),progressBarContainer=document.getElementById("progressBarContainer"),timeDisplay=document.getElementById("timeDisplay"),autoplayToggle=document.getElementById("autoplayToggle"),volumeSlider=document.getElementById("volumeSlider"),volumeBtn=document.getElementById("volumeBtn"),volumeIcon=document.getElementById("volumeIcon"),mutedIcon=document.getElementById("mutedIcon");let audioContext=null,gainNode=null,audioSource=null;const midiPlayerContainer=document.getElementById("midiPlayerContainer"),midiNowPlaying=document.getElementById("midiNowPlaying"),closeMidiPlayer=document.getElementById("closeMidiPlayer"),downloadMidiBtn=document.getElementById("downloadMidiBtn"),midiPlayPauseBtn=document.getElementById("midiPlayPauseBtn"),midiPlayIcon=document.getElementById("midiPlayIcon"),midiPauseIcon=document.getElementById("midiPauseIcon"),midiTimeDisplay=document.getElementById("midiTimeDisplay"),toggleVisualizerBtn=document.getElementById("toggleVisualizerBtn"),midiVisualizerPane=document.getElementById("midiVisualizerPane"),closeVisualizerBtn=document.getElementById("closeVisualizerBtn"),midiProgressBar=document.getElementById("midiProgressBar"),midiProgressBarContainer=document.getElementById("midiProgressBarContainer");function setupEventListeners(){gameSelect.addEventListener("change",onGameChange),searchInput.addEventListener("input",debounce(filterSounds,300)),categoryFilter.addEventListener("change",filterSounds),characterFilter.addEventListener("change",filterSounds),closePlayer.addEventListener("click",closeAudioPlayer),downloadBtn.addEventListener("click",handleDownloadClick),playPauseBtn.addEventListener("click",togglePlayPause),progressBarContainer.addEventListener("pointerdown",startSeek),volumeSlider.addEventListener("input",onVolumeChange),volumeBtn.addEventListener("click",toggleMute),document.querySelectorAll(".format-option").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();downloadWithFormat(e.getAttribute("data-format"))}))})),document.addEventListener("click",(e=>{!formatMenu.classList.contains("active")||formatMenu.contains(e.target)||downloadBtn.contains(e.target)||hideFormatMenu()}));const e=document.getElementById("searchCaptionsToggle"),t=document.getElementById("displayCaptionsToggle");e&&e.addEventListener("change",(()=>{initializeFuse(e.checked),filterSounds()})),t&&t.addEventListener("change",(()=>{displaySounds()})),audioPlayer.addEventListener("loadedmetadata",updateDuration),audioPlayer.addEventListener("timeupdate",onTimeUpdateThrottled),audioPlayer.addEventListener("ended",onAudioEnded),audioPlayer.addEventListener("error",onAudioError),audioPlayer.addEventListener("play",(()=>{playIcon.style.display="none",pauseIcon.style.display="block",playPauseBtn.setAttribute("aria-label","Pause"),startProgressLoop()})),audioPlayer.addEventListener("pause",(()=>{playIcon.style.display="block",pauseIcon.style.display="none",playPauseBtn.setAttribute("aria-label","Play"),stopProgressLoop(),updateTimeDisplay(!0)})),closeMidiPlayer.addEventListener("click",closeMidiAudioPlayer),downloadMidiBtn.addEventListener("click",downloadCurrentMidi),midiPlayPauseBtn.addEventListener("click",toggleMidiPlayPause),toggleVisualizerBtn.addEventListener("click",toggleVisualizer),closeVisualizerBtn.addEventListener("click",hideVisualizer),midiProgressBarContainer.addEventListener("click",seekMidiTo)}function onGameChange(){currentGame=gameSelect.value,closeAudioPlayer(),closeMidiAudioPlayer(),loadSounds()}function isMidiFile(e){const t=e.toLowerCase().split(".").pop();return"mid"===t||"midi"===t}async function loadSounds(){try{loadingMessage.style.display="block",errorMessage.style.display="none",soundList.innerHTML="";const e=`../data/sounds-${currentGame}.json`,t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch sounds-${currentGame}.json`);allSounds=await t.json(),allSounds.forEach((e=>{(!e.category||""===e.category.trim()||e.category.endsWith(".wav")||e.category.endsWith(".mp3"))&&(e.category="uncategorized")})),filteredSounds=[...allSounds],currentPage=0,displayedSounds=[],hasMoreToLoad=!0,isSearching=!1,initializeFuse(),loadingMessage.style.display="none",displaySounds(),updateStats(),populateCategories(),populateCharacters()}catch(e){console.error("Error loading sounds:",e),loadingMessage.style.display="none",errorMessage.style.display="block"}}function initializeFuse(e=!0){const t=[{name:"fileName",weight:2},{name:"path",weight:1},{name:"displayName",weight:2},{name:"category",weight:.5}];e&&t.push({name:"caption",weight:4});fuse=new Fuse(allSounds,{keys:t,threshold:.15,distance:500,minMatchCharLength:2,includeScore:!0,findAllMatches:!1,shouldSort:!0})}function populateCategories(){const e=[...new Set(allSounds.map((e=>e.category)))].sort();categoryFilter.innerHTML='<option value="all">All Categories</option>',e.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e.charAt(0).toUpperCase()+e.slice(1),categoryFilter.appendChild(t)})),updateCustomSelect("categoryFilter")}function populateCharacters(){const e=[...new Set(allSounds.filter((e=>e.character)).map((e=>e.character)))].sort();characterFilter.innerHTML='<option value="all">All Characters</option>',e.length>0?(e.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,characterFilter.appendChild(t)})),characterFilter.parentElement.style.display="block"):characterFilter.parentElement.style.display="none",updateCustomSelect("characterFilter")}function filterSounds(){const e=searchInput.value.trim(),t=categoryFilter.value,o=characterFilter.value;let n;if(e.length>=2){n=fuse.search(e).map((e=>e.item)),isSearching=!0}else 0===e.length?(n=[...allSounds],isSearching=!1):(n=[],isSearching=!1);filteredSounds=n.filter((e=>{const n=e.category||"uncategorized",a="all"===t||n===t,i="all"===o||e.character===o;return a&&i})),currentPage=0,displayedSounds=[],hasMoreToLoad=!0,displaySounds(),updateStats()}function displaySounds(){if(isSearching)return soundList.innerHTML="",0===filteredSounds.length?void(soundList.innerHTML='\n <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">\n No sounds found matching your criteria.\n </div>\n '):(filteredSounds.forEach((e=>{const t=createSoundItem(e);soundList.appendChild(t)})),displayedSounds=[...filteredSounds],void(hasMoreToLoad=!1));if(0===currentPage&&(soundList.innerHTML="",displayedSounds=[]),0===filteredSounds.length)return soundList.innerHTML='\n <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">\n No sounds found matching your criteria.\n </div>\n ',void(hasMoreToLoad=!1);const e=currentPage*ITEMS_PER_PAGE,t=e+ITEMS_PER_PAGE,o=filteredSounds.slice(e,t);0!==o.length?(o.forEach((e=>{const t=createSoundItem(e);soundList.appendChild(t),displayedSounds.push(e)})),hasMoreToLoad=t<filteredSounds.length):hasMoreToLoad=!1}function createSoundItem(e){const t=document.createElement("div");t.className="sound-item";const o=e.category||"uncategorized",n=document.getElementById("displayCaptionsToggle")?.checked??!0;let a=o;if(e.commentarySpeaker){a+=`<span class="sound-commentary-speaker${n?"":" hidden"}"> üéôÔ∏è ${escapeHtml(e.commentarySpeaker)}</span>`}if(e.character){a+=`<span class="sound-commentary-speaker${n?"":" hidden"}"> <svg class="character-icon" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; margin-right: 2px;"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>${escapeHtml(e.character)}</span>`}let i=`\n <div class="sound-category">${a}</div>\n <div class="sound-name">${e.displayName}</div>\n `;if(e.caption&&""!==e.caption.trim()){i+=`<div class="sound-caption${n?"":" hidden"}">"${escapeHtml(e.caption)}"</div>`}return i+=`<div class="sound-path">${e.path}</div>`,t.innerHTML=i,t.addEventListener("click",(()=>playSound(e))),t}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function getAudioUrl(e,t,o,n=!1){if("cdn"===t.host)return`https://cdn.sourcesfx.com/${e}/${o}`;if("hl2"===e&&o.includes("commentary"))return`https://cdn.sourcesfx.com/${e}/${o}`;const a=`https://raw.githubusercontent.com/${t.repo}/refs/heads/master/${o}`;if(n)return a;try{const t=await fetch(a,{method:"HEAD"});if(t.ok)return a;if(404===t.status)return`https://cdn.sourcesfx.com/${e}/${o}`}catch(t){return`https://cdn.sourcesfx.com/${e}/${o}`}}async function playSound(e,t=!1){const o=GAMES[currentGame],n=isMidiFile(e.fileName),a=await getAudioUrl(currentGame,o,e.path,n);if(n)return void playMidiSound(a,e,t);currentAudioUrl=a,currentAudioFileName=e.fileName,closeMidiAudioPlayer(),progressBar.style.transform="scaleX(0)",timeDisplay.textContent="0:00 / 0:00",stopProgressLoop(),delete audioPlayer.dataset.decodingAttempted,fetchAudioBlob(a),audioPlayer.src=a;autoplayToggle.checked||t?(initWebAudio(),audioPlayer.play().then((()=>{startProgressLoop()})).catch((e=>{console.error("Error playing audio:",e)}))):audioPlayer.load(),nowPlaying.textContent=`Now Playing: ${e.displayName}`,audioPlayerContainer.style.display="block"}async function fetchAudioBlob(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Failed to fetch audio");currentAudioBlob=await t.blob()}catch(e){console.error("Error fetching audio blob:",e),currentAudioBlob=null}}function closeAudioPlayer(){audioPlayer.pause(),stopProgressLoop(),audioPlayerContainer.style.display="none",currentAudioUrl=null,currentAudioBlob=null,currentAudioFileName=null,progressBar.style.transform="scaleX(0)",playIcon.style.display="block",pauseIcon.style.display="none",playPauseBtn.setAttribute("aria-label","Play"),hideFormatMenu()}function showFormatMenu(){formatMenu.classList.add("active")}function hideFormatMenu(){formatMenu.classList.remove("active")}function handleDownloadClick(e){if(e.stopPropagation(),currentAudioBlob&&currentAudioFileName)if(enableConversionToggle.checked){formatMenu.classList.contains("active")?hideFormatMenu():showFormatMenu()}else downloadWithFormat("original");else console.error("Audio blob not ready yet")}async function downloadWithFormat(e){if(hideFormatMenu(),currentAudioBlob&&currentAudioFileName)try{if("original"===e){const e=URL.createObjectURL(currentAudioBlob),t=document.createElement("a");return t.href=e,t.download=currentAudioFileName,document.body.appendChild(t),t.click(),document.body.removeChild(t),void setTimeout((()=>URL.revokeObjectURL(e)),100)}downloadBtn.classList.add("converting"),downloadBtn.innerHTML='\n <svg class="btn-icon" viewBox="0 0 24 24" width="18" height="18">\n <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor"/>\n </svg>\n Converting...\n ';const t=await convertAudioFormat(currentAudioBlob,e),o=`${currentAudioFileName.replace(/\.[^/.]+$/,"")}.${e}`,n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=o,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout((()=>URL.revokeObjectURL(n)),100)}catch(e){console.error("Error converting audio:",e),alert("Failed to convert audio. Please try downloading the original format.")}finally{downloadBtn.classList.remove("converting"),downloadBtn.innerHTML='\n <svg class="btn-icon" viewBox="0 0 24 24" width="18" height="18">\n <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor"/>\n </svg>\n Download\n '}else console.error("Audio blob not ready yet")}async function checkCodecSupport(){if(!window.Mediabunny)return;const{canEncodeAudio:e}=window.Mediabunny;if(window.MediabunnyMp3Encoder){const{registerMp3Encoder:e}=window.MediabunnyMp3Encoder;e()}const t=await e("mp3"),o=await e("opus"),n=await e("vorbis");document.querySelectorAll(".format-option").forEach((e=>{const a=e.getAttribute("data-format");let i=!0;("mp3"!==a||t)&&("ogg"!==a||o||n)||(i=!1),i||(e.disabled=!0,e.style.opacity="0.4",e.style.cursor="not-allowed",e.title=`${a.toUpperCase()} encoding not supported in your browser`)}))}async function convertAudioFormat(e,t){const{Input:o,Output:n,Conversion:a,ALL_FORMATS:i,BlobSource:r,BufferTarget:l,Mp3OutputFormat:d,OggOutputFormat:s,WavOutputFormat:c}=window.Mediabunny;if("mp3"===t&&window.MediabunnyMp3Encoder){const{registerMp3Encoder:e}=window.MediabunnyMp3Encoder;e()}const u=new o({formats:i,source:new r(e)});let m,y={};switch(t){case"mp3":m=new d,y={codec:"mp3",bitrate:192e3};break;case"ogg":m=new s,y={codec:"opus",bitrate:128e3};break;case"wav":m=new c,y={codec:"pcm-s16"};break;default:throw new Error(`Unsupported format: ${t}`)}const p=new n({format:m,target:new l}),g=await a.init({input:u,output:p,audio:y});if(!g.isValid){const e=g.discardedTracks.map((e=>e.reason)).join(", ");throw new Error(`Conversion failed: ${e}. Your browser may not support encoding to ${t.toUpperCase()}.`)}return await g.execute(),new Blob([p.target.buffer],{type:m.mimeType})}function togglePlayPause(){audioPlayer.paused?(initWebAudio(),audioPlayer.play()):audioPlayer.pause()}function startProgressLoop(){rafId&&cancelAnimationFrame(rafId);const e=()=>{if(audioPlayer.paused||isSeeking||!audioPlayer.duration)rafId=null;else{const t=audioPlayer.currentTime/audioPlayer.duration;progressBar.style.transform=`scaleX(${t})`,updateTimeDisplay(!1),rafId=requestAnimationFrame(e)}};rafId=requestAnimationFrame(e)}function stopProgressLoop(){rafId&&(cancelAnimationFrame(rafId),rafId=null)}function onTimeUpdateThrottled(){updateTimeDisplay(!1)}function updateProgress(){if(!isSeeking&&audioPlayer.duration){const e=audioPlayer.currentTime/audioPlayer.duration;progressBar.style.transform=`scaleX(${e})`,updateTimeDisplay(!1)}}function updateTimeDisplay(e=!1){const t=performance.now();if(!e&&t-lastTimeDisplayUpdate<150)return;lastTimeDisplayUpdate=t;const o=formatTime(audioPlayer.currentTime||0),n=formatTime(audioPlayer.duration||0);timeDisplay.textContent=`${o} / ${n}`}function updateDuration(){updateTimeDisplay(!0)}function clamp(e,t,o){return Math.max(t,Math.min(o,e))}function eventToPercent(e){const t=progressBarContainer.getBoundingClientRect();return clamp(e-t.left,0,t.width)/t.width}function seekToPercent(e){if(e=clamp(e,0,1),!isFinite(audioPlayer.duration)||audioPlayer.readyState<2){const t=e,o=()=>{isFinite(audioPlayer.duration)&&(audioPlayer.currentTime=t*audioPlayer.duration,progressBar.style.transform=`scaleX(${t})`,updateTimeDisplay(!0)),audioPlayer.removeEventListener("loadedmetadata",o),audioPlayer.removeEventListener("canplay",o)};return audioPlayer.addEventListener("loadedmetadata",o),void audioPlayer.addEventListener("canplay",o)}audioPlayer.currentTime=e*audioPlayer.duration,progressBar.style.transform=`scaleX(${e})`,updateTimeDisplay(!0)}function startSeek(e){e.preventDefault();try{progressBarContainer.setPointerCapture(e.pointerId)}catch{}isSeeking=!0,progressBar.classList.add("seeking"),stopProgressLoop();seekToPercent(eventToPercent(e.clientX)),progressBarContainer.addEventListener("pointermove",onSeekMove),progressBarContainer.addEventListener("pointerup",endSeek),progressBarContainer.addEventListener("pointercancel",endSeek)}function onSeekMove(e){if(!isSeeking)return;const t=eventToPercent(e.clientX);if(progressBar.style.transform=`scaleX(${t})`,isFinite(audioPlayer.duration)){const e=t*audioPlayer.duration;timeDisplay.textContent=`${formatTime(e)} / ${formatTime(audioPlayer.duration)}`}}function endSeek(e){if(!isSeeking)return;seekToPercent(eventToPercent(e.clientX)),isSeeking=!1,progressBar.classList.remove("seeking");try{progressBarContainer.releasePointerCapture(e.pointerId)}catch{}progressBarContainer.removeEventListener("pointermove",onSeekMove),progressBarContainer.removeEventListener("pointerup",endSeek),progressBarContainer.removeEventListener("pointercancel",endSeek),audioPlayer.paused||startProgressLoop()}function onAudioEnded(){playIcon.style.display="block",pauseIcon.style.display="none",playPauseBtn.setAttribute("aria-label","Play"),stopProgressLoop(),progressBar.style.transform="scaleX(0)",audioPlayer.currentTime=0,updateTimeDisplay(!0)}async function onAudioError(e){const t=e.target.error;if(t&&t.code===MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED){if(currentAudioUrl&&!audioPlayer.dataset.decodingAttempted){audioPlayer.dataset.decodingAttempted="true";try{await decodeAndPlayMsAdpcm(currentAudioUrl)}catch(e){console.error("Failed to decode MS-ADPCM:",e),delete audioPlayer.dataset.decodingAttempted}}}else console.error("Audio playback error:",t)}async function decodeAndPlayMsAdpcm(e){const t=await fetch(e);if(!t.ok)throw new Error("Failed to fetch audio file");const o=await t.arrayBuffer(),n=msadpcmDecodeWavFile(o),a=URL.createObjectURL(n);currentAudioBlob=n,audioPlayer.src=a,delete audioPlayer.dataset.decodingAttempted;if(autoplayToggle.checked)try{initWebAudio(),await audioPlayer.play(),startProgressLoop()}catch(e){console.error("Error playing decoded audio:",e)}else audioPlayer.load()}function formatTime(e){if(isNaN(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}function updateStats(){const e=GAMES[currentGame].name;isSearching||filteredSounds.length===allSounds.length?soundCount.textContent=`${e}: Showing ${filteredSounds.length} of ${allSounds.length} sounds`:soundCount.textContent=`${e}: Showing ${displayedSounds.length} of ${filteredSounds.length} sounds (${allSounds.length} total)`}function debounce(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout((()=>{clearTimeout(o),e(...n)}),t)}}function setupInfiniteScroll(){const e=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&hasMoreToLoad&&!isLoadingMore&&!isSearching&&loadMoreSounds()}))}),{rootMargin:"200px"}),t=document.createElement("div");t.id="scroll-sentinel",t.style.height="1px",document.querySelector(".container").appendChild(t),e.observe(t)}function loadMoreSounds(){isLoadingMore||!hasMoreToLoad||isSearching||(isLoadingMore=!0,loadingMoreIndicator.style.display="block",setTimeout((()=>{currentPage++,displaySounds(),updateStats(),loadingMoreIndicator.style.display="none",isLoadingMore=!1}),100))}function initCustomSelects(){document.querySelectorAll(".filter-select").forEach((e=>{createCustomSelect(e)}))}function createCustomSelect(e){const t=document.createElement("div");t.className="custom-select-wrapper";const o=document.createElement("div");o.className="custom-select-trigger";const n=document.createElement("span");n.className="custom-select-text",n.textContent=e.options[e.selectedIndex].text;const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("class","custom-select-arrow"),a.setAttribute("viewBox","0 0 12 12"),a.setAttribute("width","12"),a.setAttribute("height","12");const i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("fill","#ff6600"),i.setAttribute("d","M6 9L1 4h10z"),a.appendChild(i),o.appendChild(n),o.appendChild(a);const r=document.createElement("div");r.className="custom-select-options";let l=0;Array.from(e.children).forEach((t=>{if("OPTGROUP"===t.tagName){const o=document.createElement("div");o.className="custom-select-option optgroup-label",o.textContent=t.label,r.appendChild(o),Array.from(t.children).forEach((t=>{const o=document.createElement("div");o.className="custom-select-option optgroup-item",o.textContent=t.text,o.dataset.value=t.value,o.dataset.index=l,t.selected&&o.classList.add("selected"),o.addEventListener("click",(()=>{selectOption(e,o,n,r)})),r.appendChild(o),l++}))}else if("OPTION"===t.tagName){const o=document.createElement("div");o.className="custom-select-option",o.textContent=t.text,o.dataset.value=t.value,o.dataset.index=l,t.selected&&o.classList.add("selected"),o.addEventListener("click",(()=>{selectOption(e,o,n,r)})),r.appendChild(o),l++}})),o.addEventListener("click",(e=>{e.stopPropagation(),closeAllSelects(t),o.classList.toggle("active"),r.classList.toggle("active")})),e.parentNode.insertBefore(t,e),t.appendChild(o),t.appendChild(r),t.dataset.selectId=e.id}function selectOption(e,t,o,n){e.selectedIndex=t.dataset.index;const a=new Event("change",{bubbles:!0});e.dispatchEvent(a),o.textContent=t.textContent,n.querySelectorAll(".custom-select-option").forEach((e=>{e.classList.remove("selected")})),t.classList.add("selected"),n.classList.remove("active"),n.previousElementSibling.classList.remove("active")}function closeAllSelects(e=null){document.querySelectorAll(".custom-select-wrapper").forEach((t=>{t!==e&&(t.querySelector(".custom-select-trigger")?.classList.remove("active"),t.querySelector(".custom-select-options")?.classList.remove("active"))}))}function updateCustomSelect(e){const t=document.querySelector(`.custom-select-wrapper[data-select-id="${e}"]`);if(!t)return;const o=document.getElementById(e),n=t.querySelector(".custom-select-options"),a=t.querySelector(".custom-select-text");n.innerHTML="",Array.from(o.options).forEach(((e,t)=>{const i=document.createElement("div");i.className="custom-select-option",i.textContent=e.text,i.dataset.value=e.value,i.dataset.index=t,e.selected&&(i.classList.add("selected"),a.textContent=e.text),i.addEventListener("click",(()=>{selectOption(o,i,a,n)})),n.appendChild(i)}))}function initializeVolume(){const e=localStorage.getItem("audioVolume"),t=null!==e?parseFloat(e):100;volumeSlider.value=t,audioPlayer.volume=t/100,updateVolumeSliderStyle(t),updateVolumeIcon(t)}function initWebAudio(){if(!audioContext)try{audioContext=new(window.AudioContext||window.webkitAudioContext),gainNode=audioContext.createGain(),gainNode.gain.value=audioPlayer.volume,audioSource=audioContext.createMediaElementSource(audioPlayer),audioSource.connect(gainNode).connect(audioContext.destination)}catch(e){console.warn("Web Audio API not available:",e)}}function onVolumeChange(e){const t=parseFloat(e.target.value);audioPlayer.volume=t/100,gainNode&&(gainNode.gain.value=t/100),localStorage.setItem("audioVolume",t),updateVolumeSliderStyle(t),updateVolumeIcon(t)}function updateVolumeSliderStyle(e){volumeSlider.style.setProperty("--volume-percent",`${e}%`)}function updateVolumeIcon(e){0===e?(volumeIcon.style.display="none",mutedIcon.style.display="block",volumeBtn.setAttribute("aria-label","Unmute")):(volumeIcon.style.display="block",mutedIcon.style.display="none",volumeBtn.setAttribute("aria-label","Mute"))}function toggleMute(){if(audioPlayer.volume>0)localStorage.setItem("previousVolume",volumeSlider.value),volumeSlider.value=0,audioPlayer.volume=0,gainNode&&(gainNode.gain.value=0),updateVolumeSliderStyle(0),updateVolumeIcon(0);else{const e=localStorage.getItem("previousVolume")||100;volumeSlider.value=e,audioPlayer.volume=e/100,gainNode&&(gainNode.gain.value=e/100),updateVolumeSliderStyle(e),updateVolumeIcon(e)}}function initMidiPlayer(){customElements.get("midi-player")&&customElements.get("midi-visualizer")?(midiPlayer=document.getElementById("midiPlayer"),midiVisualizer=document.getElementById("midiVisualizer"),midiPlayer&&midiVisualizer&&midiPlayer.addVisualizer(midiVisualizer),midiPlayer&&(midiPlayer.addEventListener("start",onMidiStart),midiPlayer.addEventListener("stop",onMidiStop),midiPlayer.addEventListener("note",updateMidiTime))):setTimeout(initMidiPlayer,100)}function onMidiStart(){midiPlayIcon.style.display="none",midiPauseIcon.style.display="block",midiPlayPauseBtn.setAttribute("aria-label","Pause")}function onMidiStop(){midiPlayIcon.style.display="block",midiPauseIcon.style.display="none",midiPlayPauseBtn.setAttribute("aria-label","Play")}function updateMidiTime(){if(midiPlayer&&void 0!==midiPlayer.currentTime&&void 0!==midiPlayer.duration){const e=formatTime(midiPlayer.currentTime),t=formatTime(midiPlayer.duration);if(midiTimeDisplay.textContent=`${e} / ${t}`,midiPlayer.duration>0){const e=midiPlayer.currentTime/midiPlayer.duration;midiProgressBar.style.transform=`scaleX(${e})`}}}function seekMidiTo(e){if(!midiPlayer||!midiPlayer.duration)return;const t=midiProgressBarContainer.getBoundingClientRect(),o=e.clientX-t.left,n=Math.max(0,Math.min(1,o/t.width)),a=n*midiPlayer.duration;midiPlayer.currentTime=a,midiProgressBar.style.transform=`scaleX(${n})`,updateMidiTime()}function toggleMidiPlayPause(){midiPlayer&&(midiPlayer.playing?midiPlayer.stop():midiPlayer.start())}function toggleVisualizer(){"none"===midiVisualizerPane.style.display?showVisualizer():hideVisualizer()}function showVisualizer(){midiVisualizerPane.style.display="block",toggleVisualizerBtn.classList.add("active")}function hideVisualizer(){midiVisualizerPane.style.display="none",toggleVisualizerBtn.classList.remove("active")}async function playMidiSound(e,t,o=!1){currentMidiUrl=e,currentMidiFileName=t.fileName,closeAudioPlayer(),midiTimeDisplay.textContent="0:00 / 0:00",midiProgressBar.style.transform="scaleX(0)",midiPlayIcon.style.display="block",midiPauseIcon.style.display="none";try{const n=await fetch(e);if(!n.ok)throw new Error("Failed to fetch MIDI file");currentMidiBlob=await n.blob();const a=new FileReader;a.onload=function(e){midiPlayer&&(midiPlayer.src=e.target.result,setTimeout((()=>{updateMidiTime();(autoplayToggle.checked||o)&&midiPlayer&&midiPlayer.start&&midiPlayer.start()}),200))},a.readAsDataURL(currentMidiBlob),midiNowPlaying.textContent=`Now Playing: ${t.displayName}`,midiPlayerContainer.style.display="block","none"===midiVisualizerPane.style.display&&showVisualizer()}catch(e){console.error("Error loading MIDI file:",e),alert("Failed to load MIDI file. The file may not exist or may be corrupted.")}}document.addEventListener("DOMContentLoaded",(()=>{initCustomSelects(),loadSounds(),setupEventListeners(),initializeVolume(),initMidiPlayer(),setupInfiniteScroll(),checkCodecSupport()})),document.addEventListener("click",(()=>{closeAllSelects()}));const analyticsBanner=document.getElementById("analyticsBanner");!localStorage.getItem("hideAnalyticsBanner")&&analyticsBanner&&(analyticsBanner.style.display="flex");const hideAnalyticsBannerBtn=document.getElementById("hideAnalyticsBanner");function closeMidiAudioPlayer(){midiPlayer&&midiPlayer.stop&&midiPlayer.stop(),midiPlayerContainer.style.display="none",hideVisualizer(),currentMidiUrl=null,currentMidiBlob=null,currentMidiFileName=null,midiTimeDisplay.textContent="0:00 / 0:00",midiProgressBar.style.transform="scaleX(0)"}async function downloadCurrentMidi(){if(!currentMidiBlob||!currentMidiFileName)return void console.error("MIDI file not ready yet");const e=URL.createObjectURL(currentMidiBlob),t=document.createElement("a");t.href=e,t.download=currentMidiFileName,document.body.appendChild(t),t.click(),document.body.removeChild(t),setTimeout((()=>{URL.revokeObjectURL(e)}),100)}hideAnalyticsBannerBtn&&analyticsBanner&&(hideAnalyticsBannerBtn.onclick=function(){localStorage.setItem("hideAnalyticsBanner","1"),analyticsBanner.style.display="none"});
//# sourceMappingURL=/js/sourcemaps/script.min.js.map